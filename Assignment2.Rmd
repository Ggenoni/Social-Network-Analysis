---
title: "Assignment2"
author: "Gaudenzia Genoni"
date: "2024-12-30"
output: 
  pdf_document:    
    latex_engine: xelatex
    keep_tex: true
    number_sections: false
knitr:
  opts_chunk:
    echo: true              
    warning: true           
    message: true           
    fig.align: "center"     
    fig.width: 6            
    fig.height: 4           
editor_options: 
  markdown: 
    wrap: sentence
---

# Exponential Random Graph Model

#### By Marco Di Stasio, Alessandra Gandini, Gaudenzia Genoni, Yishak Tadele Nigatu

# Introduction

This study applies ERGM analysis to a directed, valued friendship network of 32 network scientists, derived from the Electronic Information Exchange System (EIES) dataset.
After dichotomizing the network, three models were estimated:

1.  Purely structural model, capturing key network-level features such as reciprocity, degree distribution, and triadic structures;
2.  Dyadic-independent model incorporating gender attributes to assess individual-level effects; and
3.  Combined model integrating both structural and attribute-based effects.

The coefficients of the models are interpreted with a substantial focus on Model 3, followed by goodness-of-fit diagnostics to evaluate how well each model replicates the observed network structure and relational patterns.
The combined model, which includes structural features and gender-related effects, provides the most comprehensive representation of the network.
However, discrepancies in extreme degree values, certain triadic configurations, and long-range connectivity suggest room for refinement to account for additional effects.

## Part 1

```{r import packages, echo=TRUE, message=FALSE}
library(sna)
library(ergm)
library(readxl)
library(knitr)
library(broom)
```

```{r load main data, echo=TRUE}
EIES_T2F_n <- read.csv("data/EIES_T2.csv", row.names=1)
EIES_T2F_n <- EIES_T2F_n > 2 #consider only friends (3) and good friends (4)

EIES_T2F_n<-as.network(EIES_T2F_n, directed=T) #transform into a network object
```

```{r load gender data, fig.align='center'}
Attributes <- read_excel("data/Data_Gender_3.xlsx")
EIES_T2F_n %v% "Gender"<- Attributes$Gender

plot(EIES_T2F_n)
gplot(EIES_T2F_n, gmode="graph", displaylabels=T, vertex.col=EIES_T2F_n %v% "Gender"*2)
```

The study examines acquaintance relationships among 32 network scientists using the EIES dataset at Time 2.
To focus on strong ties, the directed, valued network was dichotomized and transformed into a network: edges with values of 3 (friend) or 4 (close personal friend) were coded as 1, and all others (0, 1, 2) were coded as 0.
Gender attributes (from an external dataset) were then assigned to each node, creating an enriched network object for analysis.

Three exponential random graph models (ERGMs) are estimated.
**Model 1** captures purely structural effects, including edges, mutual ties, geometrically weighted in-degree and out-degree distributions, and two-path dependencies (outgoing and incoming).
**Model 2** examines dyadic independent effects by incorporating individual and dyadic attributes, specifically gender as a nodal covariate for both in-degree and out-degree, as well as gender homophily through nodal matching.
**Model 3** combines structural and attribute-based effects, integrating the terms from both Models 1 and 2 to provide a comprehensive analysis of the network.

### Model 1

```{r train model1, , message=FALSE, fig.show='hide',warning=FALSE, echo=FALSE}
EIES_Model1<-ergm(EIES_T2F_n ~ edges+mutual
                  +gwidegree(decay=.3, fixed=TRUE) +gwodegree(decay=.3, fixed=TRUE)
                  +dgwesp(type="OTP", decay=.5, fixed=TRUE)
                  +dgwesp(type="ITP", decay=.5, fixed=TRUE),
                  control=control.ergm(seed=102, MCMC.runtime.traceplot=TRUE), 
                  verbose=TRUE)
```

```{r model1_summary,echo=FALSE}
summary(EIES_Model1)
```

### Model 2

```{r train_model2, , message=FALSE, fig.show='hide',warning=FALSE, echo=FALSE}
EIES_Model2<-ergm(EIES_T2F_n ~ edges+mutual
                  +nodeicov("Gender")+nodeocov("Gender")+nodematch("Gender"), 
                  control=control.ergm(seed=102, MCMC.runtime.traceplot=TRUE), 
                  verbose=TRUE)
```

```{r model2_summary, echo=FALSE}
summary(EIES_Model2)
```

### Model 3

```{r train model3, message=FALSE, fig.show='hide',warning=FALSE, echo=FALSE}
EIES_Model3<-ergm(EIES_T2F_n ~ edges+mutual
                  +gwidegree(decay=.3, fixed=TRUE) +gwodegree(decay=.3, fixed=TRUE)
                  +dgwesp(type="OTP", decay=.5, fixed=TRUE)
                  +dgwesp(type="ITP", decay=.5, fixed=TRUE)
                  +nodeicov("Gender")+nodeocov("Gender")+nodematch("Gender"), 
                  control=control.ergm(seed=102, MCMC.runtime.traceplot=TRUE), 
                  verbose=TRUE)

```

```{r model3_summary, echo=FALSE}
summary(EIES_Model3)
```

The results are presented in the following table:

| Effect           | Model 1 Estimate (SE) | Model 1 Sign | Model 2 Estimate (SE) | Model 2 Sign | Model 3 Estimate (SE) | Model 3 Sign |
|-----------|-----------|-----------|-----------|-----------|-----------|-----------|
| edges            | -4.825 (0.363)        | \*\*\*       | -2.941 (0.185)        | \*\*\*       | -5.562 (0.446)        | \*\*\*       |
| mutual           | 2.603 (0.344)         | \*\*\*       | 2.486 (0.291)         | \*\*\*       | 2.678 (0.360)         | \*\*\*       |
| gwideg.fixed     | 2.195 (1.135)         | .            | NA                    | NA           | 1.641 (1.164)         |              |
| gwodeg.fixed     | 4.377 (2.792)         |              | NA                    | NA           | 16.286 (7.005)        | \*           |
| gwesp.OTP.fixed  | 1.967 (0.218)         | \*\*\*       | NA                    | NA           | 1.853 (0.223)         | \*\*\*       |
| gwesp.ITP.fixed  | -0.627 (0.110)        | \*\*\*       | NA                    | NA           | -0.637 (0.118)        | \*\*\*       |
| nodeicov.Gender  | NA                    | NA           | 0.053 (0.217)         |              | 0.005 (0.189)         |              |
| nodeocov.Gender  | NA                    | NA           | 1.274 (0.210)         | \*\*\*       | 1.236 (0.309)         | \*\*\*       |
| nodematch.Gender | NA                    | NA           | -0.027 (0.162)        |              | -0.071 (0.161)        |              |

## Part Two: Discussion of ERGM Results

In Model 3, Five effects are significant (edges, mutual, gwodeg.fixed, gwesp.OTP.fixed, and gwesp.ITP.fixed), while the remaining three (gwideg.fixed, nodeicov.Gender, and nodematch.Gender) are not.

Below, we discuss **Model 3** in detail and highlight notable differences from **Models 1** (structural only) and **2** (attributes only).

### Model 3 Descriptions

1.  **Edges**
    -   **Estimate (SE)**: **-5.562 (0.446)**, **p \< 0.001**
    -   **Interpretation**: The strong negative coefficient indicates a low baseline propensity for any given pair to be "friends". In a friendship context, this is typical because only a minority of all possible ties are strong friendships. This could also be a result of the sparsity of the network.
2.  **Mutual**
    -   **Estimate (SE)**: **2.678 (0.360)**, **p \< 0.001**
    -   **Interpretation**: This significant positive effect suggests a strong tendency for reciprocity. In other words, if Person A calls Person B a friend, Person B is much more likely to call Person A a friend in return. This effect remains comparably large and significant across all models (it is also highly significant in **Models 1** and **2**).
3.  **gwidegree**
    -   **Estimate (SE)**: **1.641 (1.164)**, **not significant**
    -   **Interpretation**: This parameter captures "popularity" (i.e., whether certain nodes consistently receive many friendship nominations). Although it was marginally significant in **Model 1** (p ≈ 0.05) and still positive here, it is not statistically significant in **Model 3**. After accounting for other structural and gender effects, there is no strong residual tendency for some individuals to be universally popular as "friends."
4.  **gwodegree**
    -   **Estimate (SE)**: **16.286 (7.005)**, **p \< 0.05**
    -   **Interpretation**: This effect captures "activity" (i.e., sending out multiple friendship nominations). While this effect was positive but not statistically significant in **Model 1**, it becomes both larger and significant in **Model 3**, implying that once we control for gender and other structural factors, some individuals indeed nominate friends at a higher‐than‐expected rate. Substantively, this suggests a group of "active connectors" who name multiple close colleagues as friends.
5.  **dgwesp.OTP**
    -   **Estimate (SE)**: **1.853 (0.223)**, **p \< 0.001**
    -   **Interpretation**: A positive and significant OTP parameter indicates that triadic closure is especially likely when an individual sends ties to two different people (i.e., "friends of my out‐friends tend to be my friends too"). This finding aligns with typical friendship processes where one's out‐contacts may be more likely to know each other, and it is very similar in magnitude to **Model 1**, implying that adding gender attributes does not substantially alter this triadic closure dynamic.
6.  **dgwesp.ITP**
    -   **Estimate (SE)**: **-0.637 (0.118)**, **p \< 0.001**
    -   **Interpretation**: In contrast, the negative and significant ITP parameter implies that if two people both receive ties from the same individual, they are *less* likely than random to be tied themselves (once we account for all other effects). In friendship terms, this suggests that people do not necessarily become friends merely because they share a common "admirer." This pattern remains consistent from **Model 1** through **Model 3**.
7.  **nodeicov("Gender") - male**
    -   **Estimate (SE)**: **0.005 (0.189)**, **not significant**
    -   **Interpretation**: This coefficient tests whether being **male(coded as 0)** makes one more likely to *receive* friend nominations. It is essentially zero and non‐significant, indicating that once we control for other network tendencies, male actors do not appear to receive significantly more (or fewer) friendship ties than female actors.
8.  **nodeocov("Gender"=1) - female**
    -   **Estimate (SE)**: **1.236 (0.309)**, **p \< 0.001**
    -   **Interpretation**: This significant positive coefficient indicates that **females(coded as 1)** are more likely to send friendship ties than males. Notably, it was also significant in **Model 2** at a similar magnitude (1.274). Thus, even after accounting for structural processes like reciprocity and triadic closure, women in this network remain more active in naming friends than men.
9.  **nodematch("Gender"=0)**
    -   **Estimate (SE)**: **-0.071 (0.161)**, **not significant**
    -   **Interpretation**: This nonsignificant coefficient suggests that there is no strong homophily or heterophily by gender for close friendships---i.e., men do not show a strong tendency to befriend men, nor women to befriend women, relative to cross‐gender friendships, once other factors are considered. This is consistent across **Models 2** and **3**.

### Notable Differences from Models 1 and 2 to Model 3

-   **gwodegree**: Became statistically significant in **Model 3** but was not in **Model 1**(β=4.372,p=0.117), highlighting that individuals who send many ties ("outgoing activity") do not significantly influence the overall network structure at this stage. However, when gender attributes are introduced in Model 3, individuals who actively initiate multiple friendships (high out-degree) appear to play an important role in shaping the network, especially when considering the sender's gender. This could reflect that certain individuals are more proactive in initiating friendships, and their role becomes more evident when both structural and gender-related effects are accounted for.
-   **Edges**: Became more strongly negative in **Model 3** (--5.562) than in **Models 1** or **2**, a typical pattern when multiple positive interaction processes (e.g., reciprocity, triadic closure) are added.
-   **gwidegree**: Marginally significant in **Model 1** (p ≈ 0.05, β=2.195), then not significant when attributes were included in **Model 3**. This suggests that individuals who receive many ties (are "popular") have a slightly increased likelihood of forming additional friendships. When gender attributes are introduced in Model 3, the previously observed in-degree popularity effect is partly explained by other structural or gender-related factors. This suggests that "popularity" in terms of receiving ties is less crucial in explaining tie formation when accounting for sender gender and other structural dynamics. Friendship in this network may not be strongly driven by central hubs but instead distributed across more reciprocal or cohesive relationships.

Generally, **Model 3** demonstrates that both structural forces (reciprocity, triadic closure, activity patterns) and gender attributes shape who becomes friends in this network, though some anticipated effects (like gender‐based popularity or homophily) do not appear to be present.

## Part 3: Goodness of Fit

When performing an ERGM analysis, it is of crucial importance to examine the goodness of fit, as it evaluates how well the model captures the observed network's structure and relational patterns.
Here, goodness-of-fit (GOF) diagnostics were performed by setting a random seed to ensure reproducibility across runs.
Subsequently, 2000 networks were simulated for comparison with the observed network, using the same seed for consistency.
The GOF was calculated for the three models, comparing observed network statistics with those simulated from the model.
The diagnostics include: - *model*: it evaluates how well the model itself fits the data.
- *idegree and odegree*: it assesses the in-degree and out-degree distributions.
- *distance*: it examines the geodesic distance distribution (shortest path lengths between nodes).
- *triadcensus*: it evaluates the distribution of triadic configurations in the network.
These additional metrics (degree distributions, distance, and triadic configurations) are used to complement the evaluation of the model fit.
While the model statistic assesses overall fit, the additional metrics help pinpoint specific network features the model may under- or overestimate.

```{r goodness of fit declaration}
set.seed(565)
gof.choices<-control.gof.ergm(nsim=2000, seed = 565)
```

```{r model1 gof}
#Model 1
EIES_Model1sim2000<-gof(EIES_Model1, 
                        GOF=~model+idegree+odegree+distance+triadcensus, control=gof.choices)
EIES_Model1sim2000$summary.model
```

Overall, the goodness-of-fit diagnostics for Model 1 indicate that the observed network statistics align closely with the simulated values across all metrics.
This suggests that Model 1 provides an adequate fit for capturing the structural properties of the observed network.

```{r model2 gof}
#Model 2
EIES_Model2sim2000<-gof(EIES_Model2, 
                        GOF=~model+idegree+odegree+distance+triadcensus, control=gof.choices)
EIES_Model2sim2000$summary.model
```

The goodness-of-fit diagnostics for Model 2 demonstrate that the observed network statistics are well-replicated by the simulated networks, too.

```{r model3 gof}
#Model 3
EIES_Model3sim2000<-gof(EIES_Model3, 
                        GOF=~model+idegree+odegree+distance+triadcensus, control=gof.choices)
EIES_Model3sim2000$summary.model
```

The goodness-of-fit diagnostics for Model 3 indicate a strong alignment between the observed network statistics and the simulated values, as reflected by high MC p-values across all metrics.
Structural effects, such as edges, mutual ties, and measures of triadic closure (gwesp.OTP.fixed.0.5 and gwesp.ITP.fixed.0.5), are well-captured by the model, showing minimal discrepancies between observed and simulated values.
Additionally, gender-related covariates, including nodeicov.Gender, nodeocov.Gender, and nodematch.Gender, are also accurately represented, suggesting that the model effectively incorporates both structural and attribute-based dynamics.
This demonstrates that Model 3 provides a robust and comprehensive fit to the observed friendship network.

These findings are shown in the histograms below.

```{r histograms, fig.width=30, fig.height=15, echo=FALSE}
# Set up the plotting area to have 3 rows and 3 columns
par(mfrow = c(3, 3))

# Histogram of edges
hist(EIES_Model3sim2000$sim.model[,1] + 0.01, nclass = 20, main = "Histogram of edges", probability = TRUE, xlab = NA)
abline(v = EIES_Model3sim2000$summary.model[1, 1], col = "red", lwd = 3)
abline(v = EIES_Model3sim2000$summary.model[1, 3], col = "blue", lwd = 3, lty = 2)

# Histogram of mutual
hist(EIES_Model3sim2000$sim.model[,2] + 0.01, nclass = 25, main = "Histogram of mutual", probability = TRUE, xlab = NA)
abline(v = EIES_Model3sim2000$summary.model[2, 1], col = "red", lwd = 3)
abline(v = EIES_Model3sim2000$summary.model[2, 3], col = "blue", lwd = 3, lty = 2)

# Histogram of gwideg
hist(EIES_Model3sim2000$sim.model[,3] + 0.01, nclass = 30, main = "Histogram of gwideg", probability = TRUE, xlab = NA)
abline(v = EIES_Model3sim2000$summary.model[3, 1], col = "red", lwd = 3)
abline(v = EIES_Model3sim2000$summary.model[3, 3], col = "blue", lwd = 3, lty = 2)

# Histogram of gwodeg
hist(EIES_Model3sim2000$sim.model[,4] + 0.01, nclass = 30, main = "Histogram of gwodeg", probability = TRUE, xlab = NA)
abline(v = EIES_Model3sim2000$summary.model[4, 1], col = "red", lwd = 3)
abline(v = EIES_Model3sim2000$summary.model[4, 3], col = "blue", lwd = 3, lty = 2)

# Histogram of gwesp.OTP
hist(EIES_Model3sim2000$sim.model[,5] + 0.01, nclass = 30, main = "Histogram of gwesp.OTP", probability = TRUE, xlab = NA)
abline(v = EIES_Model3sim2000$summary.model[5, 1], col = "red", lwd = 3)
abline(v = EIES_Model3sim2000$summary.model[5, 3], col = "blue", lwd = 3, lty = 2)

# Histogram of gwesp.ITP
hist(EIES_Model3sim2000$sim.model[,6] + 0.01, nclass = 30, main = "Histogram of gwesp.ITP", probability = TRUE, xlab = NA)
abline(v = EIES_Model3sim2000$summary.model[6, 1], col = "red", lwd = 3)
abline(v = EIES_Model3sim2000$summary.model[6, 3], col = "blue", lwd = 3, lty = 2)

# Histogram of nodeicov.Gender
hist(EIES_Model3sim2000$sim.model[,7] + 0.01, nclass = 30, main = "Histogram of nodeicov.Gender", probability = TRUE, xlab = NA)
abline(v = EIES_Model3sim2000$summary.model[7, 1], col = "red", lwd = 3)
abline(v = EIES_Model3sim2000$summary.model[7, 3], col = "blue", lwd = 3, lty = 2)

# Histogram of nodeocov.Gender
hist(EIES_Model3sim2000$sim.model[,8] + 0.01, nclass = 30, main = "Histogram of nodeocov.Gender", probability = TRUE, xlab = NA)
abline(v = EIES_Model3sim2000$summary.model[8, 1], col = "red", lwd = 3)
abline(v = EIES_Model3sim2000$summary.model[8, 3], col = "blue", lwd = 3, lty = 2)

# Histogram of nodematch.Gender
hist(EIES_Model3sim2000$sim.model[,9] + 0.01, nclass = 30, main = "Histogram of nodematch.Gender", probability = TRUE, xlab = NA)
abline(v = EIES_Model3sim2000$summary.model[9, 1], col = "red", lwd = 3)
abline(v = EIES_Model3sim2000$summary.model[9, 3], col = "blue", lwd = 3, lty = 2)

```

The *trace plots* showed below are visual diagnostics used to assess the convergence of the Markov Chain Monte Carlo (MCMC) algorithm in Model 3.
They display the sampled values of parameters over iterations, allowing for the identification of issues such as non-convergence or autocorrelation.
A well-mixed and stable trace plot indicates that the MCMC has converged, ensuring reliable parameter estimates for the ERGM.

```{r trace plots, fig.width=40, fig.height=30, echo=FALSE}

par(mfrow = c(3, 3))

plot(EIES_Model3sim2000$sim.model[,1], type="l", main = paste("Trace plot for edges"), ylab="", xlab="")

plot(EIES_Model3sim2000$sim.model[,2], type="l", main = paste("Trace plot for mutual"), ylab="", xlab="")

plot(EIES_Model3sim2000$sim.model[,3], type="l", main = paste("Trace plot for gwideg"), ylab="", xlab="")

plot(EIES_Model3sim2000$sim.model[,4], type="l", main = paste("Trace plot for gwodeg"), ylab="", xlab="")

plot(EIES_Model3sim2000$sim.model[,5], type="l", main = paste("Trace plot for gwesp.OTP"), ylab="", xlab="")

plot(EIES_Model3sim2000$sim.model[,6], type="l", main = paste("Trace plot for gwesp.ITP"), ylab="", xlab="")

plot(EIES_Model3sim2000$sim.model[,7], type="l", main = paste("Trace plot for nodeicov.Gender "), ylab="", xlab="")

plot(EIES_Model3sim2000$sim.model[,8], type="l", main = paste("Trace plot for nodeocov.Gender "), ylab="", xlab="")

plot(EIES_Model3sim2000$sim.model[,9], type="l", main = paste("Trace plot for nodematch.Gender "), ylab="", xlab="")
```

Finally, the evaluation of the model fit is completed with the analysis of additional metrics, along with a re-presentation of the GOF for model statistics (which was already discussed above).

```{r}
EIES_Model3sim2000
```

The goodness-of-fit diagnostics for the additional metrics in Model 3 reveal varying levels of alignment between the observed and simulated network statistics, as detailed below for each of them.
- **Goodness-of-fit for in-degree**: the model captures the overall in-degree distribution reasonably well for most categories, as indicated by high MC p-values (e.g., idegree6 p=0.926, idegree7 p=1.000, and idegree10 p=1.000).
However, there are notable deviations for specific categories.
For example, idegree1 (p=0.207) is underestimated, as the observed frequency (3) is higher than the mean prediction (1.1410).
Conversely, idegree5 (p=0.169) is overestimated, with the predicted mean (3.8815) exceeding the observed value (1).
Additionally, idegree24 shows a complete mismatch (p=0.000), indicating the model fails to replicate extreme high in-degree values, likely due to their rarity in the network.
- **Goodness-of-fit for out-degree**: - **Goodness-of-fit for minimum geodesic distance**: - **Goodness-of-fit for triad census**:

```{r}
par(mfrow = c(2,3))
plot(EIES_Model3sim2000)
```

```{r}
boxplot(EIES_Model3sim2000$sim.odeg[,1:11])  
```

```{r}

EIES_Model3sim2000$obs.odeg
```

```{r, fig.width=40, fig.height=30, echo=FALSE}

par(mfrow = c(4, 4))
for (k in 1:16)
{
  hist(EIES_Model3sim2000$sim.triadcensus[,k], main=colnames(EIES_Model3sim2000$sim.triadcensus)[k])
  abline(v = EIES_Model3sim2000$obs.triadcensus[k], col = "blue", lwd = 3, lty=2)
}

```

```{r}

EIES_Model3sim2000$obs.triadcensus
```

In conclusion, the model is satisfactory in capturing the overall structure and many relational patterns of the network, particularly those related to reciprocity, clustering, and the influence of gender attributes.
However, its limitations in handling extreme degree values, specific triadic structures, and longer paths suggest that additional effects may need to be included to improve the model's fit.
These could include effects related to preferential attachment, node-specific roles, or alternative triadic configurations, which might better capture the underlying processes driving tie formation in the network.
